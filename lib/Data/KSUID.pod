=encoding UTF-8

=head1 NAME

Data::KSUID - K-Sortable Unique IDentifiers

=head1 SYNOPSIS

    use Data::KSUID ':all';

    # Use the functional interface
    my $ksuid = create_ksuid;
    say ksuid_to_string($ksuid);

    # Or objects, if you're so inclined
    my $ksuid = Data::KSUID->new;
    say $ksuid->string;

=head1 DESCRIPTION

KSUID are a globally unique identifier similar to UUIDs but designed to be
naturally sorted by generation timestamp and to have representations that
are easily postable across systems.

You can read more about KSUIDs and the rationale for their use in the
documentation for
L<the original implementation|https://github.com/segmentio/ksuid>
by Segment.io and its
L<accompanying blog post|https://segment.com/blog/a-brief-history-of-the-uuid>.

This distribution aims to provide a fast and lightweight implementation of
these. It offers a functional interface based on that of L<UUID::Tiny>, and
an object-oriented one that may be faster if your use-case entails running
multiple operations your KSUIDs.

=head1 FUNCTIONAL INTERFACE

These functions avoid the overhead of creating an object, but since we have
no control over the data they are called on, they have to validate it before
running.

If you are going to be running multiple operations on your KSUIDs, the
object-oriented interface might be faster.

=head2 create_ksuid

    $bytes = create_ksuid(
        $timestamp // time,
        $payload   // <random bytes>
    );

Takes an optional timestamp and payload and returns the binary representation
of a KSUID. These binary strings are guaranteed to always be 20 bytes long.

If no timestamp is set, the current timestamp will be used. If no payload is
set, the KSUID will use a random set of bytes as provided by
 L<Crypt::URandom/urandom>.

The provided timestamp should be a numeric UNIX timestamp, such as those
provided by core C<time>. The provided payload must be 16 bytes long. If any
of these conditions is not met, this function will die.

For a similar function that returns a KSUID string, see L</create_ksuid_string>.

=head2 create_ksuid_string

    $string = create_ksuid_string(
        $timestamp // time,
        $payload   // <random bytes>
    );

Takes an optional timestamp and payload and returns the string representation
of a KSUID. These strings are guaranteed to always be 27 characters long.

If no timestamp is set, the current timestamp will be used. If no payload is
set, the KSUID will use a random set of bytes as provided by
 L<Crypt::URandom/urandom>.

The provided timestamp should be a numeric UNIX timestamp, such as those
provided by core C<time>. The provided payload must be 16 bytes long. If any
of these conditions is not met, this function will die.

For a similar function that returns a binary KSUID, see L</create_ksuid>.

=head2 ksuid_to_string

    $string = ksuid_to_string($ksuid)

Takes a mandatory KSUID as a binary string and returns a base 62-encoded
representation of it as a 27-character string. This string will only use
upper and lowercase alphanumeric characters, so it should be safe to print
and store in any environment where these are valid.

If the provided KSUID is not one that L</is_ksuid> would accept, this
function will throw an exception.

For the reverse operation, see L</string_to_ksuid>.

=head2 string_to_ksuid

    $ksuid = string_to_ksuid($string)

Takes a mandatory KSUID as a string and returns a binary representation of
it as a 20-byte string.

If the provided KSUID string is not one that L</is_ksuid_string> would accept,
this function will throw an exception.

For the reverse operation, see L</ksuid_to_string>.

=head2 time_of_ksuid

    $timestamp = time_of_ksuid($ksuid)

Takes a mandatory KSUID as a binary string and returns the timestamp that
was used when it was created as an integer like the one that you would get
from C<time>.

If the provided KSUID is not one that L</is_ksuid> would accept, this
function will throw an exception.

=head2 payload_of_ksuid

    $bytes = payload_of_ksuid($ksuid)

Takes a mandatory KSUID as a binary string and returns the 16-byte payload
that was used when it was created.

If the provided KSUID is not one that L</is_ksuid> would accept, this
function will throw an exception.

=head2 next_ksuid

    $next = next_ksuid($ksuid)

Takes a mandatory KSUID as a binary string and returns the binary string
representation of a different KSUID that will sort immediately after the
original one. This is useful in contexts were very many KSUIDs will be
generated in a short span, and they need to be guaranteed to sort in a
specific order.

If the provided KSUID is not one that L</is_ksuid> would accept, this
function will throw an exception.

For the reverse operation, see L</previous_ksuid>.

=head2 previous_ksuid

    $previous = previous_ksuid($ksuid)

Takes a mandatory KSUID as a binary string and returns the binary string
representation of a different KSUID that will sort immediately before the
original one. This is useful in contexts were very many KSUIDs will be
generated in a short span, and they need to be guaranteed to sort in a
specific order.

If the provided KSUID is not one that L</is_ksuid> would accept, this
function will throw an exception.

For the reverse operation, see L</next_ksuid>.

=head2 is_ksuid

    $bool = is_ksuid($ksuid)

Checks whether the parameter that was provided is a binary KSUID and
returns a true or false value accordingly.

For validating KSUID strings, see L</is_ksuid_string>.

=head2 is_ksuid_string

    $bool = is_ksuid_string($string)

Checks whether the parameter that was provided is the string representation
of a KSUID and returns a true or false value accordingly.

For validating KSUID strings, see L</is_ksuid_string>.

=head1 OBJECT INTERFACE

The object-oriented interface incurs the overhead of creating an object, but
since have control over its internal state, its methods can skip most of the
validation when executed.

If you are simply going to be creating KSUIDs eg. for export, then the
functional interface might be faster.

=head2 new

    $ksuid = Data::KSUID->new(
        $timestamp // time,
        $payload   // <random bytes>
    );

Takes an optional timestamp and payload and returns a KSUID object.

If no timestamp is set, the current timestamp will be used. If no payload is
set, the KSUID will use a random set of bytes as provided by
 L<Crypt::URandom/urandom>.

The provided timestamp should be a numeric UNIX timestamp, such as those
provided by core C<time>. The provided payload must be 16 bytes long. If any
of these conditions is not met, this function will die.

=head2 parse

    $ksuid = Data::KSUID->parse($string)

Takes a mandatory KSUID as a string and returns an object for the KSUID it
represents.

If the provided KSUID string is not one that L</is_ksuid_string> would accept,
this function will throw an exception.

For the reverse operation, see L</string>.

=head2 string

    $string = $ksuid->string

Returns a base 62-encoded representation of this KSUID as a 27-character
string. This string will only use upper and lowercase alphanumeric characters,
so it should be safe to print and store in any environment where these are
valid.

For a method that returns the binary representation of it, see L</bytes>.

=head2 bytes

    $bytes = $ksuid->bytes

Returns the binary representation of this KSUID as a 20-byte string.

For a method that returns the string representation of it, see L</string>.

=head2 time

    $timestamp = $ksuid->time

Returns the timestamp that was used when this KSUID was created as an integer
like the one that you would get from C<time>.

=head2 payload

    $bytes = $ksuid->payload

Returns the 16-byte payload that was used when this KSUID was created.

=head2 next

    $next = $ksuid->next

Returns a KSUID object that will sort immediately after this one. This is
useful in contexts were very many KSUIDs will be generated in a short span,
and they need to be guaranteed to sort in a specific order.

For the reverse operation, see L</previous>.

=head2 previous

    $previous = $ksuid->previous

Returns a KSUID object that will sort immediately before this one. This is
useful in contexts were very many KSUIDs will be generated in a short span,
and they need to be guaranteed to sort in a specific order.

For the reverse operation, see L</next>.

=head1 CONSTANTS

The following constants are available. These are not exported, but can be
used via their fully qualified names.

=head2 MIN

The minimum value for a KSUID. A string of 20 null bytes.

=head2 MAX

The maximum value for a KSUID. A string of 20 bytes set to C<\xFF>.

=head2 MIN_STRING

The string representation of the minimum value of a KSUID. A string of
27 zeroes.

=head2 MAX_STRING

The string representation of the maximum value of a KSUID. Equivalent to
stringifying the value of L</MAX>.

=head1 SEE ALSO

=over

=item L<https://github.com/segmentio/ksuid>

=item L<https://segment.com/blog/a-brief-history-of-the-uuid>

=back

=head1 ACKNOWLEDGEMENTS

The internal codec used to serialise and deserialise KSUIDs is based on the
algorithm implemented in the original codebase by Achille Roussel.

=head1 COPYRIGHT AND LICENSE

This software is copyright (c) 2025 by José Joaquín Atria.

This is free software; you can redistribute it and/or modify it under the same
terms as the Perl 5 programming language system itself.
